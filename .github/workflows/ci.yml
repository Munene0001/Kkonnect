name: CI Pipeline

on:
  push:
      branches: [ main, develop ]
        pull_request:
            branches: [ main, develop ]

            jobs:
              test:
                  runs-on: ubuntu-latest
                      steps:
                            - uses: actions/checkout@v4
                                  
                                        - name: Set up Python
                                                uses: actions/setup-python@v5
                                                        with:
                                                                  python-version: '3.11'
                                                                            
                                                                                  - name: Install dependencies
                                                                                          run: |
                                                                                                    python -m pip install --upgrade pip
                                                                                                              pip install -r requirements/dev.txt
                                                                                                                        
                                                                                                                              - name: Lint with pylint
                                                                                                                                      run: |
                                                                                                                                                pylint src/ tests/
                                                                                                                                                          
                                                                                                                                                                - name: Check formatting with black
                                                                                                                                                                        run: |
                                                                                                                                                                                  black --check src/ tests/
                                                                                                                                                                                            
                                                                                                                                                                                                  - name: Test with pytest
                                                                                                                                                                                                          run: |
                                                                                                                                                                                                                    pytest tests/ --cov=src
                                                                                                                                                                                                                              
                                                                                                                                                                                                                                security:
                                                                                                                                                                                                                                    runs-on: ubuntu-latest
                                                                                                                                                                                                                                        steps:
                                                                                                                                                                                                                                              - uses: actions/checkout@v4
                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                          - name: Set up Python
                                                                                                                                                                                                                                                                  uses: actions/setup-python@v5
                                                                                                                                                                                                                                                                          with:
                                                                                                                                                                                                                                                                                    python-version: '3.11'
                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                    - name: Install dependencies
                                                                                                                                                                                                                                                                                                            run: |
                                                                                                                                                                                                                                                                                                                      python -m pip install --upgrade pip
                                                                                                                                                                                                                                                                                                                                pip install safety bandit
                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                - name: Check for security vulnerabilities
                                                                                                                                                                                                                                                                                                                                                        run: |
                                                                                                                                                                                                                                                                                                                                                                  safety check
                                                                                                                                                                                                                                                                                                                                                                            bandit -r src/
                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                            - name: Run Trivy vulnerability scanner
                                                                                                                                                                                                                                                                                                                                                                                                    uses: aquasecurity/trivy-action@master
                                                                                                                                                                                                                                                                                                                                                                                                            with:
                                                                                                                                                                                                                                                                                                                                                                                                                      scan-type: 'fs'
                                                                                                                                                                                                                                                                                                                                                                                                                                scan-ref: '.'
                                                                                                                                                                                                                                                                                                                                                                                                                                          exit-code: '0'
                                                                                                                                                                                                                                                                                                                                                                                                                                                    severity: 'CRITICAL,HIGH'